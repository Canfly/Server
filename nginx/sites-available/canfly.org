server {
  listen  80;
  return  301 https://canfly.org$request_uri;
}

upstream diaspora {
	server          127.0.0.1:3000;
} 

server {
  listen 443 ssl ; #spdy; 
  server_name canfly.org;
  client_max_body_size 5M;
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate /usr/local/etc/openssl/cert.pem;
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;

  # ssl_stapling on;
  ssl on;
  ssl_certificate       ssl/canfly.org.crt;
  ssl_certificate_key   ssl/canfly.org.key;
  ssl_dhparam ssl/dhparam.pem;
  ssl_session_timeout 5m;
  ssl_session_cache shared:SSL:10m;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers kEECDH+AES128:kEECDH:kEDH:-3DES:kRSA+AES128:kEDH+3DES:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2;
  ssl_prefer_server_ciphers on;
  add_header Strict-Transport-Security "max-age=31536000;";
  add_header Content-Security-Policy-Report-Only "default-src https:; script-src https: 'unsafe-eval' 'unsafe-inline'; style-src https: 'unsafe-inline'; img-src https: data:; font-src https: data:; report-uri //cspbuilder.info/report/929117982508610234/noscripteval/;";

  root /Users/adiom/Documents/Canfly/amalgama/public;
  #limit_req   zone=one  burst=1 nodelay;
  #location /uploads/ {
  #  internal;
  #  alias   /Users/adiom/Documents/Canfly/amalgama/public/uploads/;
  #}

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  
  location / {
    proxy_redirect off;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Host $http_host;
    #proxy_set_header X-Sendfile-Type X-Accel-Redirect;
    #proxy_set_header  X-Accel-Mapping /Users/adiom/Documents/Canfly/amalgama/public/uploads/=/uploads/;
    proxy_pass http://diaspora;
      

  }



}